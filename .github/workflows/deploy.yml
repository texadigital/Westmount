name: Deploy App to VPS

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_PORT: ${{ secrets.SSH_PORT }}
      APP_ROOT: ${{ secrets.APP_ROOT }} # e.g., /home/assoc/htdocs/associationwestmount.com
      APP_DIR: ${{ secrets.APP_DIR }} # fallback support if you set APP_DIR instead
      PHP_BINARY: ${{ secrets.PHP_BINARY }} # e.g., php or /usr/bin/php8.2

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install frontend deps
        run: npm ci --no-audit --no-fund

      - name: Build assets
        run: npm run build

      - name: Prepare SSH key/config
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          printf "Host vps\n  HostName %s\n  User %s\n  Port %s\n  IdentityFile ~/.ssh/id_rsa\n  StrictHostKeyChecking no\n" "$SSH_HOST" "$SSH_USER" "${SSH_PORT:-22}" > ~/.ssh/config

      - name: Preflight and ensure remote directory exists
        run: |
          # Choose target path: prefer APP_ROOT, fallback to APP_DIR
          TARGET_ROOT="${APP_ROOT:-${APP_DIR:-}}"
          if [ -z "$TARGET_ROOT" ]; then
            echo "ERROR: APP_ROOT secret is not set (and APP_DIR fallback is empty)." >&2
            exit 1
          fi
          echo "Using TARGET_ROOT=$TARGET_ROOT"
          ssh vps "mkdir -p '$TARGET_ROOT'"

      - name: Sync code to server (rsync)
        run: |
          TARGET_ROOT="${APP_ROOT:-${APP_DIR:-}}"
          rsync -az --delete \
            --exclude-from=deploy-exclude.txt \
            -e "ssh" \
            ./ vps:"$TARGET_ROOT/"

      - name: Run server post-deploy tasks
        run: |
          TARGET_ROOT="${APP_ROOT:-${APP_DIR:-}}"
          RUN_PHP="${PHP_BINARY:-php}"
          echo "Post-deploy working directory: $TARGET_ROOT"
          echo "Using PHP command: $RUN_PHP"
          if [ -z "$TARGET_ROOT" ]; then
            echo "ERROR: TARGET_ROOT is empty" >&2
            exit 1
          fi

          # Run remote commands via heredoc so runner variables expand correctly
          ssh vps <<EOF
          set -e
          cd "$TARGET_ROOT"
          if [ ! -f .env ]; then echo "[ERROR] Missing .env at $TARGET_ROOT/.env" >&2; exit 1; fi
          if [ ! -f artisan ]; then echo "[ERROR] artisan not found in $TARGET_ROOT" >&2; ls -la; exit 1; fi
          composer install --no-dev --prefer-dist --no-progress --no-interaction --optimize-autoloader
          mkdir -p storage/framework/{cache,data,sessions,views} bootstrap/cache
          chmod -R ug+rw storage bootstrap/cache || true
          "$RUN_PHP" artisan migrate --force
          "$RUN_PHP" artisan db:seed --class=MassiveMembersSeeder --force
          "$RUN_PHP" artisan config:cache
          "$RUN_PHP" artisan route:cache || true
          "$RUN_PHP" artisan view:cache || true
          # Ensure uploads symlink exists and publish Filament assets for admin UI styling
          "$RUN_PHP" artisan storage:link || true
          "$RUN_PHP" artisan filament:assets || true
          if command -v systemctl >/dev/null 2>&1; then
            sudo systemctl reload php-fpm 2>/dev/null || sudo systemctl reload php8.2-fpm 2>/dev/null || true
            sudo systemctl reload nginx 2>/dev/null || sudo systemctl reload apache2 2>/dev/null || true
          fi
          EOF

      - name: Deployment complete
        run: echo "OK"
